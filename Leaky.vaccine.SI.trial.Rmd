---
title: "SI model of a vaccine trial"
author: ""
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
library(deSolve)
library(tidyverse)
library(EpiModel)
library(survival)
```

We are modeling a closed population SI model meant to simulate a vaccine trial. We are not modeling infections from I to S but rather only infections from the outside population, with infection rate based on the population prevalence `prev` (of viremic individuals), the exposure rate (serodiscordant sexual contacts per time) `c`, and the transmission rate (per contact) `p`. The per contact effect of vaccination is `epsilon`, and at this iteration of the model `epsilon` is not time-varying (the per contact vaccine effect does not decay over time). 

Or, AMP Trial and 703 vs 704 results; different forces of infection.

`p` = transmission rate (per contact)   
`c` = exposure rate (serodiscordant sexual contacts per time)  
`prev` = prevalence  (prevalence of viremic individuals)  
`lambda = p * c * prev`  
`epsilon` = per contact vaccine efficacy; vaccine-induced reduction in the risk of HIV infection from a single exposure  

We us an initial calibration of the infection parameters borrowing from Vandormael (2018):    

"We used realistic parameter values for the SIR model, based on earlier HIV studies that have been undertaken in the sub-Saharan Africa context. To this extent, we varied `c` within the range of 50 to 120 sexual acts per year based on data collected from serodiscordant couples across eastern and southern African sites. Previous research has shown considerable heterogeneity in the probability of HIV transmission per sexual contact, largely due to factors associated with the viral load level, genital ulcer disease, stage of HIV progression, condom use, circumcision and use of ART. Following a systematic review of this topic by Boily et al., we selected values for `β` within the range of 0.003–0.008. ... Here, we chose values for `v` within the range of 0.15–0.35, which are slightly conservative, but supported by population-based estimates from the sub-Saharan African context."

`c` varies from 50 to 120 per year   
`p` varies from 0.003 to 0.008  
`prev`, which here is population prevalence of unsuppressed VL, varies from 0.15 to 0.35  

## Model setup

Basic functions:  

`dS/dt = -lambda*S`   
`dI/dt = lambda*S`  

Sp = susceptible placebo  
Ip = infected placebo  
Sv = susceptible vaccinated  
Iv = infected vaccinated  

Svh = susceptible vaccinated high exposure  
SvL = susceptible vaccinated low exposure  
Ivh = infected vaccinated high exposure  
Ivl = infected vaccinated low exposure  

```{r parameters}

p <- 0.004   #transmission rate (per contact)
c <- 90/365   #contact rate (contacts per day)
prev <- 0.10 #needs fixing
lambda <- p*c*prev
epsilon <- 0.50 #per act vaccine efficacy
risk <- 5.0 #risk multiplier
```
  
  
```{r ODE model}

si_ode <- function(times, init, param){
  with(as.list(c(init, param)), {
    
    # Flows
    # the number of people moving from S to I at each time step
    SIp.flow <- lambda*Sp
    SIv.flow <- lambda*epsilon*Sv
    
    SIph.flow <- risk*lambda*Sph
    SIpl.flow <- lambda*Spl
    SIvh.flow <- risk*lambda*(1-epsilon)*Svh
    SIvl.flow <- lambda*(1-epsilon)*Svl
    
    # ODEs
    # placebo; homogeneous risk
    dSp <- -SIp.flow
    dIp <- SIp.flow  #lambda*Sp
    
    # vaccine; homogeneous risk
    dSv <- -SIv.flow
    dIv <- SIv.flow  #lambda*epsilon*Sv

    # placebo; heterogeneous risk
    dSph <- -SIph.flow
    dIph <- SIph.flow  #risk*lambda*Sph
    dSpl <- -SIpl.flow
    dIpl <- SIpl.flow  #lambda*Spl
    
    # vaccine; heterogeneous risk
    dSvh <- -SIvh.flow
    dIvh <- SIvh.flow  #risk*lambda*(1-epsilon)*Svh
    dSvl <- -SIvl.flow
    dIvl <- SIvl.flow  #lambda*(1-epsilon)*Svl

    #Output
    list(c(dSp,dIp,
           dSv,dIv,
           dSph,dIph,
           dSpl,dIpl,
           dSvh,dIvh,
           dSvl,dIvl,
           SIp.flow,SIv.flow,SIph.flow,SIpl.flow,SIvh.flow,SIvl.flow))
  })
}
```
  
  
```{r EpiModel}

param <- param.dcm(lambda = lambda, epsilon = epsilon, risk = risk)
init <- init.dcm(Sp = 5000, Ip = 0,
                 Sv = 5000, Iv = 0,
                 Sph = 500, Iph = 0,
                 Spl = 4500, Ipl = 0,
                 Svh = 500, Ivh = 0, 
                 Svl = 4500, Ivl = 0,
                 SIp.flow = 0, SIv.flow = 0, 
                 SIph.flow = 0, SIpl.flow = 0,
                 SIvh.flow = 0, SIvl.flow = 0)

control <- control.dcm(nsteps = 365*3, new.mod = si_ode)

mod <- dcm(param, init, control)
mod
```


```{r data}
mod <- mutate_epi(mod, num.Svh.Svl = Svh + Svl) #all susceptible and new infections in heterogeneous risk vaccine pop
mod <- mutate_epi(mod, num.Sph.Spl = Sph + Spl) #all susceptible and new infections in heterogeneous risk placebo pop

#Incidence
#SIv.flow = number of infections in one time step (one day)
#Sv = all susceptible in the homogeneous risk vaccinated pop in that one time step (one day)
#SIv.flow/(Sv) = infections per person per time step (per day)
#SIv.flow/(Sv*365) = infections per person per 1 year
#SIv.flow/(Sv*365*100) = infections per person per 100 years

#How many person years is in one day? num.Sv.flow/365

mod <- mutate_epi(mod, rate.Vaccine = (SIv.flow/Sv)*365*100)
mod <- mutate_epi(mod, rate.Placebo = (SIp.flow/Sp)*365*100)
mod <- mutate_epi(mod, rate.Vaccine.het = (SIvh.flow/num.Sph.Spl)*365*100)
mod <- mutate_epi(mod, rate.Placebo.het = (SIph.flow/num.Sph.Spl)*365*100)

#VE <- 1 - RR, or: (rate.Placebo - rate.Vaccine) / rate.Placebo)
mod <- mutate_epi(mod, VE1 = (rate.Placebo - rate.Vaccine) / rate.Placebo)
mod <- mutate_epi(mod, VE2 = (rate.Placebo.het - rate.Vaccine.het) / rate.Placebo.het)

mod
```

   
```{r plots}

par(mar = c(3,3,2,1), mgp = c(2,1,0))
plot(mod, y = c("Iv", "Ip", "Ivh", "Ivl", "Iph", "Ivl"), 
     alpha = 0.8, 
     main = "Cumulative infections",
     legend = "full")
plot(mod, y = c("SIv.flow", "SIp.flow", "SIvh.flow", "SIvl.flow", "SIph.flow", "SIpl.flow"), 
     alpha = 0.8, 
     main = "Daily infections",
     legend = "full")
plot(mod, y=c("rate.Vaccine", "rate.Placebo", "rate.Vaccine.het", "rate.Placebo.het"),
     alpha = 0.8,
     #ylim = c(0, 0.1),
     main = "Incidence rate",
     legend = "full")
plot(mod, y=c("VE1", "VE2"),
     alpha = 0.8,
     main = "Vaccine efficacy",
     legend = "full")

```


