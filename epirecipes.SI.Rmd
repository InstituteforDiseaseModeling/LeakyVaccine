---
title: "SI model of a vaccine trial"
author: "Josh Herbeck"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
library(deSolve)
library(reshape2)
library(ggplot2)
```

We are modeling a closed population SI model meant to simulate a vaccine trial. We are not modeling infections from I to S but rather only from the outside population, with infection rate based on the population prevalence `Prev` (of viremic individuals), the exposure rate (serodiscordant sexual contacts per time) `c`, and the transmission rate (per contact) `p`. The per contact effect of vaccination is `epsilon`.

p = transmission rate (per contact)  
c = exposure rate (serodiscordant sexual contacts per time)  
Prev = prevalence  (This should probably be prevalence of viremic individuals)
lambda = p * c * Prev  
epsilon = per contact vaccine efficacy; vaccine-induced reduction in the risk of HIV infection from a single exposure

## Model setup

`dS/dt = -lambda*S`  
`dI/dt = lambda*S`

Sp = susceptible placebo  
Ip = infected placebo  
Sv = susceptible vaccinated  
Iv = infected vaccinated

Svh = susceptible vaccinated high exposure  
SvL = susceptible vaccinated low exposure  
Ivh = infected vaccinated high exposure  
Ivl = infected vaccinated low exposure

```{r}
p = 0.01   #transmission rate (per contact)
c = 0.3   #contact rate (contacts per time)
Prev <- 0.20
lambda <- p*c*Prev
epsilon <- 0.50 #per act vaccine efficacy
risk <- 3.0 #risk multiplier

parms <- c(lambda, epsilon, risk)
init <- c(Sv=1000,Iv=1,Sp=1000,Ip=1,Svh=500,Ivh=1,Svl=500,Ivl=1)
times <- seq(from=1, to=365*3, by=1)

sir_ode <- function(times, init, parms){
  with(as.list(c(init, parms)), {
  # ODEs
    
  # vaccine; homogeneous risk
  #Nv <- Sv+Iv
  dSv <- -lambda*epsilon*Sv
  dIv <- lambda*epsilon*Sv 
  
  # vaccine; heterogeneous risk
  #Nv.risk <- Svh+Ivh+Svl+Ivl
  dSvh <- -risk*lambda*(1-epsilon)*Svh
  dIvh <- risk*lambda*(1-epsilon)*Svh 
  dSvl <- -lambda*(1-epsilon)*Svl
  dIvl <- lambda*(1-epsilon)*Svl
    
  #placebo
  #Np = Sp+Ip
  dSp <- -lambda*Sp
  dIp <- lambda*Sp
  
  return(list(c(dSv,dIv,dSp,dIp,dSvh,dIvh,dSvl,dIvl)))
  })
}

sir_out <- lsoda(init, times, sir_ode, parms)
```

```{r}
sir_out_long <- melt(as.data.frame(sir_out), "time")
sir_out_inf <- sir_out_long[sir_out_long$variable %in% c('Iv', 'Ip','Ivl','Ivh'),]
```

```{r}
ggplot(sir_out_inf, aes(x=time/365, y=value, color=variable, group=variable))+
  #Add line
  geom_line(lwd=2) +
  #Add labels
  xlab("Years") + ylab("Infections")
```

