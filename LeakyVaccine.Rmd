---
title: "Leaky vaccine and effect on VE of multiple exposures"
author: "Josh Herbeck"
date: "December 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load deSolve library
```{r}
library(deSolve)
#library(EpiModel)
```

# Set up the model

This is just following directly from James Moore and Dobromir Dimitrov, "Overwhelming of the vaccine efficacy in HVTN 702 by repeated exposure."

##Parameters

Risk per exposure(rho) = Risk of HIV infection during each exposure if not vaccinated
Per-act efficacy (epsilon) = Reduction in the risk of HIV infection from a single exposure due to vaccine
Fraction exposed(f) = Fraction of the population exposed to HIV (those with HIV positive partners)
Replacement rate(r) = How frequently individuals switch exposure groups (i.e. change partners or partners acquire HIV)
Annual exposure rate(theta) = Number of exposures per person year in the exposed fraction.

```{r DCM}
su_ode <- function(t, Y, par){
  
  Up <- Y[1]  # Unexposed placebo
  Sp <- Y[2]  # Susceptible placebo
  Uv <- Y[3]  # Unexposed vaccine
  Sv <- Y[4]  # Susceptible vaccine
  
  rho <- par[1]     # Risk of HIV infection during each exposure if not vaccinated
  epsilon <- par[2] # Per-act efficay; reduction in the risk of HIV infection from a single exposure due to vaccine
  f <- par[3]       # Fraction of the pop. exposed to HIV (i.e. with HIV positive partners)
  r <- par[4]       # Frequency of exposure group switch (i.e. change partners or partners acquire HIV)
  theta <- par[5]   # Number of exposures per person year in the exposed fraction. 
  
dYdt <- vector(length = 3) 

#[1] Unexposed placebo dUpdt = r*(1-f)*Sp - r*f*Up
  #              + add the susceptible placebo individuals that are not exposed and switch groups
  #              - remove the unexposed placebo individuals that are exposed and switch
#[2] Susceptible placebo dSpdt = -r*(1-f)*Sp + r*f*Up - rho*theta*Sp
  #               - remove the susceptible placebo individuals that are not exposed and switch groups
  #               + add the unexposed placebo individuals that are exposed and switch
  #               - remove the susceptible placebo individuals that get infected each year
#[3] Unexposed vaccine dUvdt = r*(1-f)*Sv - r*f*Uv
#[4] Susceptible vaccine dSvdt = -r*(1-f)*Sv + r*f*Uv - (rho*theta)(1-epsilon*t*Sv)

dYdt[1] = r*(1-f)*Sp - r*f*Up
dYdt[2] = -r*(1-f)*Sp + r*f*Up - rho*theta*Sp
dYdt[3] = r*(1-f)*Sv - r*f*Uv
dYdt[4] = -r*(1-f)*Sv + r*f*Uv - (rho*theta)*(1-(epsilon*t*Sv))

  return(list(dYdt))
}
```

# Set the parameter values

## Scenario 1
```{r parameter values}
rho <-      0.03  #par[1]    
epsilon <-  0.54  #par[2]
f <-        0.02  #par[3]      
r <-        0.03  #par[4]      
theta <-    48    #par[5]  

init  <- c(0.25, 0.25, 0.25, 0.25)
t     <- seq(0, 3)
par   <- c(rho, epsilon, f, r, theta)
```

# Solve 
```{r solve}
# Solve system using lsoda
sol <- lsoda(init, t, su_ode, par)
```

# Plot the epidemic
```{r Plot all compartments}
plot(t, sol[,1], type = "l", col = "blue", 
     ylim=c(0, 1), 
     xlab = "time in years (t)",
     ylab = "Proportion")
lines(t, sol[,2], col = "green")
lines(t, sol[,3], col = "red")
lines(t, sol[,4], col = "orange") 
#lines(t, 1-rowSums(sol[,1:4]), col="yellow")
legend(1, 1, legend = c("Unexposed placebo", 
                           "Susceptible placebo", 
                           "Unexposed vaccine",
                           "Susceptible vaccine"), 
                         col=c("blue", "green", "red", "orange"), 
                         lty=1, cex=0.8)
```

#Survival curves
```{r survival, eval=FALSE, include=FALSE}

#To do

```

